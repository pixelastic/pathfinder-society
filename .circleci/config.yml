version: 2

# Aliases, so we can reference them in our jobs to avoid duplication of code
_aliases:
  - &defaults
    docker:
      - image: circleci/node:12.12.0
  - &add_ssh_key
    add_ssh_keys:
      fingerprints:
        - 'bf:a5:61:c6:03:fb:71:f7:7a:17:a1:60:58:77:24:f6'
  - &add_npm_token
    run: 'echo "//registry.npmjs.org/:_authToken=$NPM_TOKEN" > ~/.npmrc'
  - &restore_cache
    restore_cache:
      key: yarn-cache-{{ checksum "yarn.lock" }}
  - &yarn_install
    run: 'yarn install'
  - &save_cache
    save_cache:
      key: yarn-cache-{{ checksum "yarn.lock" }}
      paths:
        - ~/.cache/yarn

# Our list of jobs, so we can reference them in our worflows
jobs:
  # This will attempt to build/test/lint, to check that the code is in good
  # shape
  ci:
    <<: *defaults
    steps:
      - checkout
      - *restore_cache
      - *yarn_install
      - *save_cache
      - run: 'yarn run ci'
  # This will recrawl the wiki, commit changes to the data.json and file and
  # submit a PR for approval of the changes
  weeklyUpdate:
    <<: *defaults
    steps:
      - *add_ssh_key
      - checkout
      - *restore_cache
      - *yarn_install
      - *save_cache
      - run: 'yarn run ci:weeklyUpdate'
  # This job will be triggered by GitHub when the weeklyUpdate PR is merged
  automatedRelease:
    <<: *defaults
    steps:
      - *add_npm_token
      - checkout
      - *restore_cache
      - *yarn_install
      - *save_cache
      - run: 'yarn run release patch'

workflows:
  version: 2
  # On every commit and PR: run the build/test/lint checks
  commit:
    jobs:
      - ci
  # Every week: Recrawl the wiki and submit a PR with the changes
  weeklyUpdate:
    triggers:
      - schedule:
          cron: '0 9 * * 2'
          filters:
            branches:
              only:
                - master
    jobs:
      - weeklyUpdate
